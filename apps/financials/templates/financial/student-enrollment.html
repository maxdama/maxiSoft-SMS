
{% extends "layouts/base.html" %}

{% block title %} Student Enrollment {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% load static %}
{% load humanize %}

{% block content %}
<div class="content">
    <div class="page-inner">

        <div class="page-header">
            <h3 class=" font-weight-bold ">New Student Enrollment</h3>
            <ul class="breadcrumbs">
                <li class="nav-home">
                    <a href="#">
                        <i class="flaticon-home"></i>
                    </a>
                </li>
                <li class="separator">
                    <i class="flaticon-right-arrow"></i>
                </li>
                <li class="nav-item">
                    <a href="list">Students</a>
                </li>
                <li class="separator">
                    <i class="flaticon-right-arrow"></i>
                </li>
                <li class="nav-item">
                    <a href="#">Biodata</a>
                </li>
            </ul>
        </div>

        <form action="" class="" method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="container d-flex justify-content-center">
                <div class="col col-md-10 ">
                    <div class="card">

                        <div class="card-header">

                            <div class="row float-sm-right " >
                                <div class="col-sm-1 form-group" >
                                    <input type="text" class="form-control no-bd" id="reg_id" name="student" value="{{student.pk}}" hidden required>
                                </div>

                                <!-- Session: &ensp; <span class="pr-5">  {{timeline.descx}}</span> -->
                                <input type="text" class="no-bd" id="sess_id" name="timeline" value="{{timeline.id}}" hidden required>
                                <input type="text" class="no-bd" id="sch_id" name="school" value="{{timeline.sch_id}}" hidden required>
                            </div>
                            <div class="row">
                                <div class="col-10">
                                    <h5 class=""><strong>Batch Placement and Invoicing: </strong><br>
                                        Academic Year: &ensp; <span class="pr-5">  {{timeline.descx}}</span>  </h5>
                                </div>
                                <div class="col-2">
                                    <!--  Close button at the TOP Right Corner. Closes the form to Employee List -->
                                    <button id="close" class=" btn  btn-outline-dark  btn-rounded btn-sm float-lg-right alert-dark "  type="button" >X</button>
                                </div>
                            </div>

                            <hr>

                            <div class="row">
                                <div class="avatar avatar-lg">
                                    {% if student.stud_pic %}
                                        <img src="{{student.stud_pic.url}}" alt="..." class="avatar-img rounded-circle">
                                    {% else %}
                                        <img src="/static/assets/img/default.png" alt="..." class="avatar-img rounded-circle">
                                    {% endif %}
                                </div>

                                <div class="no-bd col-md-5 form-floating-label ">
                                    <input id="studnames" type="text" style="font-weight:bold; font-size: 18px;" value="{{student.surname}}, {{student.first_name}} {{student.middle_name}}" class="form-control no-bd" name="studentnames" required>
                                    <label for="studnames" class="placeholder pl-3">Student Names</label>
                                </div>

                                <div class="col-md-3  " style="width:auto">
                                    <!-- <button type="button" class="btn btn-outline-dark  btn-xs gen-id">Reg-No (Auto Gen)</button> -->
                                    <span class="gen-id ">Registration No:</span>
                                    <div class="row">
                                        <div class="col-md-12 form-group w_90 pl-3  p-0 m-0">
                                            <input id="reg_no" name="reg_no" value="{{student.student.reg_no}}" readonly="" type="text" class="no-bd form-control form-control-sm pt-0 mt-0"  required>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xs-4">
                                 <!-- Date of Enrollment -->
                                     <div class="form-group form-floating-label">
                                         <input  type="date" id="trans_date" class="no-bd form-control" name="trans_date"  value="" required >
                                         <label for="trans_date" class="placeholder pl-3">Enrollment Date</label>
                                     </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-body">

                        <div class="">

                            <div class="row d-flex justify-content-center "  >

                                <div class="col-sm-2 ">
                                    <div class="form-floating-label">

                                        <select class="no-bd form-control input-border-bottom" id="session" name="session" style="font-weight:bold;" required >
                                            <option selected hidden value="{{timeline.term.idx}}">{{timeline.term.descxx}}</option>
                                            {% for s in sessions %}
                                                <option value={{s.id}} >{{s.descx}}</option>
                                            {% endfor %}
                                        </select>
                                        <label for="session" class="placeholder pl-1">Session:</label>
                                    </div>
                                </div>

                                <div class="col-md-3 ">
                                    <div class="form-floating-label">

                                        <select class="no-bd form-control input-border-bottom" id="class_id" name="classroom" style="font-weight:bold;" required >
                                            <option value=""></option>
                                            {% for cls in classes %}
                                                <option value={{cls.id}}>{{cls.class_abr}} - {{cls.arm}}  ({{timeline.descx}})</option>
                                            {% endfor %}
                                        </select>
                                        <label for="class_id" class="placeholder pl-1">Batch Placement:</label>
                                    </div>
                                </div>

                                <div class="col-md-6 ">
                                    <div class="form-floating-label">

                                        <select class="no-bd form-control input-border-bottom" id="fee_pkg" name="fee_pkg" style="font-weight:bold;" required >
                                            <option value=""></option>
                                            {% for fee in fees %}
                                                <option value="{{fee.id}}">{{fee.description}} - ( {{fee.total_fees|intcomma}} )</option>
                                            {% endfor %}

                                        </select>
                                        <label for="fee_pkg" class="placeholder pl-1">Fee Package:</label>
                                    </div>
                                </div>

                            </div>
                            <hr class=" mb-0">
                            <span class="text-small fw-extrabold font-italic">Auto Invoice </span> <p>
                            <div class="row row-demo-grid">

                                <div class="col-md-2 font-weight-bold text-left">
                                    <span class="pl-2 ">Invoice No</span>
                                      <div class="row">
                                          <div class="col-md-12 pl-4">
                                              <input  name="invoice_no" id="invoice_no" value="" tabindex="10" type="text" readonly class="form-control form-control-sm" placeholder="" required >
                                          </div>
                                      </div>
                                </div>

                                <div class="col-md-7 font-weight-bold text-left">
                                    <span class="label pl-2">Transaction Description:</span>
                                      <div class="row">
                                          <div class="col-md-12 pl-4">
                                              <input  name="descx" id="descx" value="" tabindex="10" type="text" class="form-control form-control-sm" placeholder="Admission into JSS 1 2021/2022 - 1st Term" required >
                                          </div>
                                      </div>
                                </div>

                                <div class="col-md-3 font-weight-bold text-left">
                                    <span class="pl-2 ">Amount</span>
                                      <div class="row">
                                          <div class="col-md-12 pl-4">
                                              <input  name="amount" id="amount" value="" tabindex="10" type="number" readonly class="form-control form-control-sm no-bd " placeholder=""  >
                                          </div>
                                      </div>
                                </div>

                            </div>

                        </div>
                    </div>

                        <div class="card-action card-transparent">
                            <div class="row d-flex justify-content-center text-center">
                                 <div class="col-4 ">
                                    <button class="btn btn-outline-dark btn-round btn-sm"  type="submit" name="save_and_add" value="save&add" formaction="/financials/new-enrollment/{{student.pk}}" >Save and Add Another</button>
                                 </div>
                                 <div class="col-4 ">
                                     <button class="btn btn-outline-dark btn-round btn-sm" type="submit" name="save_and_list" value="save&list" formaction="/financials/new-enrollment/{{student.pk}}" >Finish and List Enrollment</button>
                                 </div>
                                  <div class="col-4 ">
                                      <button class="btn btn-outline-dark btn-round btn-sm"  type="submit" name="save" value="save" formaction="/financials/new-enrollment/{{student.pk}}" >Finish</button>
                                  </div>
                             </div>
                        </div>

                    </div>
                </div>

            </div>

        </form>

        <div class="">
            <p class="">
                <a href="/students/list" class="">List All Students</a>
            </p>
        </div>

    </div>
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'success'%}
                <script type=text/javascript>toastr.{{ message.tags }}('{{ message }}', 'Successfull . . . ')</script>
            {% elif message.tags == 'info' %}
                <script type=text/javascript>toastr.{{ message.tags }}('{{ message }}', 'Information . . . ')</script>
            {% elif message.tags == 'warning' %}
                <script type=text/javascript>toastr.{{ message.tags }}('{{ message }}', 'Warning . . . ')</script>
            {% elif message.tags == 'error' %}
                <script type=text/javascript>toastr.{{ message.tags }}('{{ message }}', 'Error . . . ')</script>
            {% endif %}
        {% endfor %}
    {% endif %}

    <script type="text/javascript"  >

		$(document).ready(function() {

            //document.getElementById('trans_date').valueAsDate = new Date(); // Get the current Date and assigned
            document.getElementById('trans_date').value = moment().format('YYYY-MM-DD');

		});

		$(document).ready(function() {

            // document.getElementById('trans_date').valueAsDate = new Date(); // Get the current Date and assigned

            // It redirect the URL when the close button at the TOP Right corner is clicked
             $("#close").click(function(){
                 location.href='/financials/student-enrolled-list'
             });

            $('.gen-id').click(function(e){
                var regno = $("#reg_no").val()

                $.ajax(
                    {
                        method: "GET",
                        url: "{% url 'gen_reg_no' %}",
                        async: "True",
                        dataType: "json",
                        success: function( response)
                        {
                            //console.log(response);
                            var  new_reg = response.new_reg_no;
                            $( '#reg_no' ).val(new_reg);
                        },
                        error: function(xhr, status, error){
                            // alert("An Error occured:" + "\n" + response.message);
                            let msg = 'An error ocurred:' + '\n' + error;
                            sweet_alert('Error: Registration No', msg, 'info')

                        }
                    });

            });

            $('#class_id').change(function(){
                let fee_id = $('#fee_pkg').val();
                let ses_id = $('#session').val();
                let ses_text = $( "#session option:selected" ).text();

                let class_id = $(this).val();
                let class_text = $( "#class_id option:selected" ).text();

                if(fee_id && ses_id && class_id){
                    x_proc(fee_id, ses_id, ses_text, class_id, class_text);
                }
            });

            $('#session').change(function(){
                let fee_id = $('#fee_pkg').val();
                let ses_id = $(this).val();
                let ses_text = $( "#session option:selected" ).text();

                let class_id = $('#class_id').val();
                let class_text = $( "#class_id option:selected" ).text();

                if(fee_id && ses_id && class_id){
                    x_proc(fee_id, ses_id, ses_text, class_id, class_text);
                }

            });

             $('#fee_pkg').change(function(){
                let fee_id = $(this).val();
                let ses_id = $('#session').val();
                let ses_text = $( "#session option:selected" ).text();

                let class_id = $('#class_id').val();
                let class_text = $( "#class_id option:selected" ).text();

                if(fee_id && ses_id && class_id){
                    x_proc(fee_id, ses_id, ses_text, class_id, class_text);
                }
            });



            function x_proc(fee_id, ses_id, ses_text, class_id, class_text){

                let descx_text = 'Admission into ' + class_text + '  - ' + ses_text
                $('#descx').val(descx_text)
                //alert('Fee Package Change: ' + '\n' + ses_id + ': ' + ses_text + '\n' + class_id + ' : ' + class_text + '\n' + 'Fee Package ID ' + fee_id );

                let addr = '{% url "get_inv_amt" pkg_id=0 %}'.replace('0',fee_id)
                $.ajax(
                    {
                        method: "GET",
                        url: addr,
                        async: "True",
                        dataType: "json",
                        success: function(response)
                        {
                            //alert('Success ');
                            let  inv_amt = response.inv_amount;
                            let inv_no = response.inv_no;
                            let reg_no = response.reg_no;

                            $( '#amount' ).val(inv_amt);
                            $( '#invoice_no' ).val(inv_no);
                            $( '#reg_no' ).val(reg_no);

                            $("#amount").css("textAlign", "right");
                        },
                        error: function(xhr, status, error)
                        {
                            let msg = 'An error ocurred:' + '\n' + error;
                            sweet_alert('Error: Batch Placement', msg, 'info')
                        }
                    }
                );
            };

            function sweet_alert(title, msg, type)
            {
                swal({
					title: title,
					text: msg,
					type: 'info',
					buttons:{
						confirm: {
							text : 'OK',
							className : 'btn btn-info'
						}
					}
                })
            };

        });

	</script>



{% endblock javascripts %}